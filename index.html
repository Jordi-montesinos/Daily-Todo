<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weekly Task Organizer</title>

    <!-- React + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef, useEffect } = React;
      const { Plus, Trash2, Save, Upload, GripVertical } = lucide.icons;

      const WeeklyTaskOrganizer = () => {
        const [weeks, setWeeks] = useState([
          {
            id: Date.now(),
            tasks: Array(16)
              .fill(null)
              .map((_, i) => ({
                delegatedTasks: { text: "", completed: false, ranking: i + 1 },
                weeklyObjectives: { text: "", completed: false, ranking: i + 1 },
                monday: { text: "", completed: false, ranking: i + 1 },
                tuesday: { text: "", completed: false, ranking: i + 1 },
                wednesday: { text: "", completed: false, ranking: i + 1 },
                thursday: { text: "", completed: false, ranking: i + 1 },
                friday: { text: "", completed: false, ranking: i + 1 },
              })),
          },
        ]);

        const [draggedItem, setDraggedItem] = useState(null);
        const inputRefs = useRef({});
        const fileInputRef = useRef(null);

        const columns = [
          "delegatedTasks",
          "weeklyObjectives",
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
        ];
        const columnLabels = [
          "Delegated Tasks",
          "Weekly Objectives",
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
        ];

        const getWeeklyObjectivesColor = (rowIndex) => {
          if (rowIndex >= 0 && rowIndex <= 3)
            return {
              bg: "bg-red-600",
              text: "text-white",
              input: "bg-red-500 text-white placeholder-red-200",
            };
          if (rowIndex >= 4 && rowIndex <= 7)
            return {
              bg: "bg-orange-500",
              text: "text-white",
              input: "bg-orange-400 text-white placeholder-orange-200",
            };
          if (rowIndex >= 8 && rowIndex <= 11)
            return {
              bg: "bg-yellow-400",
              text: "text-black",
              input: "bg-yellow-300 text-black placeholder-yellow-600",
            };
          if (rowIndex >= 12 && rowIndex <= 15)
            return {
              bg: "bg-yellow-200",
              text: "text-black",
              input: "bg-yellow-100 text-black placeholder-yellow-500",
            };
          return { bg: "bg-white", text: "text-black", input: "bg-white text-black" };
        };

        const getDayColumnColor = (rowIndex) => {
          if (rowIndex === 0)
            return {
              bg: "bg-red-600",
              text: "text-white",
              input: "bg-red-500 text-white placeholder-red-200",
            };
          if (rowIndex >= 1 && rowIndex <= 3)
            return {
              bg: "bg-yellow-300",
              text: "text-black",
              input: "bg-yellow-200 text-black placeholder-yellow-600",
            };
          if (rowIndex >= 14)
            return {
              bg: "bg-blue-50",
              text: "text-black",
              input: "bg-blue-100 text-black placeholder-blue-400",
            };
          return { bg: "bg-white", text: "text-black", input: "bg-white text-black" };
        };

        const getCellStyle = (column, rowIndex) => {
          if (column === "weeklyObjectives") return getWeeklyObjectivesColor(rowIndex);
          if (column === "delegatedTasks")
            return { bg: "bg-white", text: "text-black", input: "bg-white text-black" };
          return getDayColumnColor(rowIndex);
        };

        const getCategoryRange = (column, rowIndex) => {
          if (column === "weeklyObjectives") {
            if (rowIndex >= 0 && rowIndex <= 3) return [0, 3];
            if (rowIndex >= 4 && rowIndex <= 7) return [4, 7];
            if (rowIndex >= 8 && rowIndex <= 11) return [8, 11];
            if (rowIndex >= 12 && rowIndex <= 15) return [12, 15];
          } else if (column === "delegatedTasks") return [0, 15];
          else {
            if (rowIndex === 0) return [0, 0];
            if (rowIndex >= 1 && rowIndex <= 3) return [1, 3];
            if (rowIndex >= 4 && rowIndex <= 13) return [4, 13];
            if (rowIndex >= 14 && rowIndex <= 15) return [14, 15];
          }
          return [0, 15];
        };

        const sortColumnByCategory = (tasks, column) => {
          const newTasks = [...tasks];
          const categories = [
            column === "weeklyObjectives" ? [0, 3] : column === "delegatedTasks" ? [0, 15] : [0, 0],
            column === "weeklyObjectives" ? [4, 7] : column === "delegatedTasks" ? null : [1, 3],
            column === "weeklyObjectives" ? [8, 11] : column === "delegatedTasks" ? null : [4, 13],
            column === "weeklyObjectives" ? [12, 15] : column === "delegatedTasks" ? null : [14, 15],
          ].filter(Boolean);

          categories.forEach(([start, end]) => {
            const categoryTasks = [];
            for (let i = start; i <= end; i++)
              categoryTasks.push({ task: newTasks[i][column], index: i });

            const incomplete = categoryTasks.filter((t) => !t.task.completed);
            const completed = categoryTasks.filter((t) => t.task.completed);
            incomplete.sort((a, b) => a.task.ranking - b.task.ranking);

            const sorted = [...incomplete, ...completed];
            sorted.forEach((item, idx) => {
              newTasks[start + idx] = {
                ...newTasks[start + idx],
                [column]: item.task,
              };
            });
          });
          return newTasks;
        };

        const updateTask = (weekId, rowIndex, column, field, value) => {
          setWeeks((prev) =>
            prev.map((week) => {
              if (week.id !== weekId) return week;
              let newTasks = [...week.tasks];
              if (field === "ranking") {
                const num = parseInt(value) || 1;
                const [catStart, catEnd] = getCategoryRange(column, rowIndex);
                const other = newTasks.findIndex(
                  (t, i) => i >= catStart && i <= catEnd && i !== rowIndex && t[column].ranking === num
                );
                if (other !== -1) {
                  newTasks[other] = {
                    ...newTasks[other],
                    [column]: { ...newTasks[other][column], ranking: newTasks[rowIndex][column].ranking },
                  };
                }
                newTasks[rowIndex] = {
                  ...newTasks[rowIndex],
                  [column]: { ...newTasks[rowIndex][column], [field]: num },
                };
              } else {
                newTasks[rowIndex] = {
                  ...newTasks[rowIndex],
                  [column]: { ...newTasks[rowIndex][column], [field]: value },
                };
              }
              newTasks = sortColumnByCategory(newTasks, column);
              return { ...week, tasks: newTasks };
            })
          );
        };

        const handleDragStart = (e, weekId, rowIndex, column) => {
          setDraggedItem({ weekId, rowIndex, column });
          e.dataTransfer.effectAllowed = "move";
        };
        const handleDragOver = (e) => e.preventDefault();
        const handleDrop = (e, weekId, targetRowIndex, targetColumn) => {
          e.preventDefault();
          if (!draggedItem || draggedItem.weekId !== weekId || draggedItem.column !== targetColumn)
            return setDraggedItem(null);
          setWeeks((prev) =>
            prev.map((week) => {
              if (week.id !== weekId) return week;
              const newTasks = [...week.tasks];
              const s = draggedItem.rowIndex;
              const t = targetRowIndex;
              [newTasks[s][targetColumn], newTasks[t][targetColumn]] = [
                newTasks[t][targetColumn],
                newTasks[s][targetColumn],
              ];
              return { ...week, tasks: newTasks };
            })
          );
          setDraggedItem(null);
        };

        const addNewWeek = () => {
          const last = weeks[0];
          const newTasks = Array(16)
            .fill(null)
            .map((_, i) => ({
              delegatedTasks: { text: "", completed: false, ranking: i + 1 },
              weeklyObjectives: { text: "", completed: false, ranking: i + 1 },
              monday: { text: "", completed: false, ranking: i + 1 },
              tuesday: { text: "", completed: false, ranking: i + 1 },
              wednesday: { text: "", completed: false, ranking: i + 1 },
              thursday: { text: "", completed: false, ranking: i + 1 },
              friday: { text: "", completed: false, ranking: i + 1 },
            }));
          setWeeks([{ id: Date.now(), tasks: newTasks }, ...weeks]);
        };

        const deleteWeek = (id) => {
          if (weeks.length > 1) setWeeks(weeks.filter((w) => w.id !== id));
        };

        const saveToFile = () => {
          const blob = new Blob([JSON.stringify(weeks, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `weekly-organizer-${new Date().toISOString().split("T")[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
        };

        const loadFromFile = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const loaded = JSON.parse(ev.target.result);
              setWeeks(loaded);
            } catch {
              alert("Invalid file format");
            }
          };
          reader.readAsText(file);
        };

        useEffect(() => lucide.createIcons());

        return (
          <div className="p-6 max-w-[1800px] mx-auto">
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold text-gray-800">
                Weekly Task Organizer
              </h1>
              <div className="flex gap-3">
                <button
                  onClick={saveToFile}
                  className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"
                >
                  <i data-lucide="save" className="w-4 h-4"></i> Save
                </button>
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg"
                >
                  <i data-lucide="upload" className="w-4 h-4"></i> Load
                </button>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept=".json"
                  onChange={loadFromFile}
                  className="hidden"
                />
                <button
                  onClick={addNewWeek}
                  className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
                >
                  <i data-lucide="plus" className="w-4 h-4"></i> Add Week
                </button>
              </div>
            </div>

            {weeks.map((week, index) => (
              <div key={week.id} className="mb-8 bg-white rounded-lg shadow p-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-semibold text-gray-700">
                    Week {weeks.length - index}
                  </h2>
                  {weeks.length > 1 && (
                    <button
                      onClick={() => deleteWeek(week.id)}
                      className="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm"
                    >
                      <i data-lucide="trash-2" className="w-4 h-4"></i> Delete
                    </button>
                  )}
                </div>

                <div className="overflow-x-auto">
                  <table className="w-full border-collapse">
                    <thead>
                      <tr>
                        {columnLabels.map((label) => (
                          <th
                            key={label}
                            className="border border-gray-300 p-2 bg-gray-700 text-white text-sm"
                          >
                            {label}
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {week.tasks.map((task, row) => (
                        <tr key={row}>
                          {columns.map((col) => {
                            const styles = getCellStyle(col, row);
                            return (
                              <td
                                key={col}
                                className={`border border-gray-300 p-1 ${styles.bg}`}
                                draggable
                                onDragStart={(e) =>
                                  handleDragStart(e, week.id, row, col)
                                }
                                onDragOver={handleDragOver}
                                onDrop={(e) => handleDrop(e, week.id, row, col)}
                              >
                                <div className="flex items-start gap-1">
                                  <i
                                    data-lucide="grip-vertical"
                                    className={`w-3 h-3 ${styles.text}`}
                                  ></i>
                                  <input
                                    type="checkbox"
                                    checked={task[col].completed}
                                    onChange={(e) =>
                                      updateTask(
                                        week.id,
                                        row,
                                        col,
                                        "completed",
                                        e.target.checked
                                      )
                                    }
                                    className="w-3.5 h-3.5 mt-0.5"
                                  />
                                  <input
                                    type="number"
                                    min="1"
                                    value={task[col].ranking}
                                    onChange={(e) =>
                                      updateTask(
                                        week.id,
                                        row,
                                        col,
                                        "ranking",
                                        e.target.value
                                      )
                                    }
                                    className={`w-8 text-xs text-center border-0 outline-none ${styles.input}`}
                                  />
                                  <textarea
                                    value={task[col].text}
                                    onChange={(e) =>
                                      updateTask(
                                        week.id,
                                        row,
                                        col,
                                        "text",
                                        e.target.value
                                      )
                                    }
                                    className={`flex-1 text-xs border-0 outline-none resize-none ${styles.input}`}
                                    placeholder="Task..."
                                    rows="1"
                                  />
                                </div>
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            ))}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<WeeklyTaskOrganizer />);
    </script>
  </body>
</html>
