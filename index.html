<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Task Organizer</title>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide (icons) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <style>
    body { margin: 0; }
    table td, table th { vertical-align: top; }
    /* hide default number input spinners */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

/* ---------- ISO week helpers ---------- */
function getISOWeekAndYear(date) {
  const tmp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  tmp.setUTCDate(tmp.getUTCDate() + 4 - (tmp.getUTCDay() || 7));
  const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
  return [weekNo, tmp.getUTCFullYear()];
}
function getDateOfISOWeek(week, year) {
  const jan4 = new Date(Date.UTC(year, 0, 4));
  const jan4Day = jan4.getUTCDay() || 7;
  const monday = new Date(jan4);
  monday.setUTCDate(jan4.getUTCDate() - (jan4Day - 1) + (week - 1) * 7);
  return new Date(monday.getUTCFullYear(), monday.getUTCMonth(), monday.getUTCDate());
}
function formatDayShort(d) {
  const dd = String(d.getDate()).padStart(2,'0');
  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return dd + '/' + monthNames[d.getMonth()];
}

/* ---------- tasks/week defaults ---------- */
function makeEmptyTasks() {
  return Array(16).fill(null).map((_, i) => ({
    delegatedTasks: { text: "", completed: false, ranking: i+1 },
    weeklyObjectives: { text: "", completed: false, ranking: i+1 },
    monday: { text: "", completed: false, ranking: i+1 },
    tuesday: { text: "", completed: false, ranking: i+1 },
    wednesday: { text: "", completed: false, ranking: i+1 },
    thursday: { text: "", completed: false, ranking: i+1 },
    friday: { text: "", completed: false, ranking: i+1 }
  }));
}

/* compute current week/year for defaults */
const [currentWeek, currentYear] = getISOWeekAndYear(new Date());
/**********************
 * Main Component
 **********************/
function WeeklyTaskOrganizer() {
  // initialize from localStorage or default single week
  const initial = () => {
    const saved = localStorage.getItem('weekly-task-organizer');
    if (saved) {
      try { return JSON.parse(saved); } catch {}
    }
    return [{
      id: Date.now(),
      weekNumber: currentWeek,
      year: currentYear,
      tasks: makeEmptyTasks()
    }];
  };

  const [weeks, setWeeks] = useState(initial);
  const [activeTab, setActiveTab] = useState('organizer'); // 'organizer' | 'summary'
  const [draggedItem, setDraggedItem] = useState(null);
  const inputRefs = useRef({});
  const fileInputRef = useRef(null);
  const [copiedKeys, setCopiedKeys] = useState(()=> new Set());

  const columns = ["delegatedTasks","weeklyObjectives","monday","tuesday","wednesday","thursday","friday"];

  /* colors */
  function getWeeklyObjectivesColor(i){
    if(i<=3) return { bg:"#dc2626", text:"white" };
    if(i<=7) return { bg:"#f97316", text:"white" };
    if(i<=11) return { bg:"#facc15", text:"black" };
    return { bg:"#fde68a", text:"black" };
  }
  function getDayColumnColor(i){
    if(i===0) return { bg:"#dc2626", text:"white" };
    if(i<=3) return { bg:"#fcd34d", text:"black" };
    if(i>=14) return { bg:"#eff6ff", text:"black" };
    return { bg:"#ffffff", text:"black" };
  }
  function getCellStyle(col, rowIndex){
    if(col === 'weeklyObjectives') return getWeeklyObjectivesColor(rowIndex);
    if(col === 'delegatedTasks') return { bg:"#ffffff", text:"black" };
    return getDayColumnColor(rowIndex);
  }

  /* sorting + update logic */
  function getCategoryRange(col, rowIndex){
    if(col === 'weeklyObjectives'){
      if(rowIndex <= 3) return [0,3];
      if(rowIndex <= 7) return [4,7];
      if(rowIndex <= 11) return [8,11];
      return [12,15];
    }
    if(col === 'delegatedTasks') return [0,15];
    if(rowIndex === 0) return [0,0];
    if(rowIndex <= 3) return [1,3];
    if(rowIndex <= 13) return [4,13];
    return [14,15];
  }

  function sortColumnByCategory(tasks, col){
  const newTasks = [...tasks];
  const ranges = [
    getCategoryRange(col,0),
    getCategoryRange(col,4),
    getCategoryRange(col,8),
    getCategoryRange(col,12)
  ];
  ranges.forEach(([start,end])=>{
    const seg = [];
    for(let i=start;i<=end;i++) seg.push({ task:newTasks[i][col], rowIndex:i });

    const incomplete = seg.filter(s=>!s.task.completed).sort((a,b)=>a.task.ranking-b.task.ranking);
    const complete   = seg.filter(s=> s.task.completed).sort((a,b)=>a.task.ranking-b.task.ranking);
    const merged = [...incomplete, ...complete];

    // normalize rankings inside this category
    merged.forEach((it, idx)=>{
      const normalized = { ...it.task, ranking: idx+1 };
      newTasks[start + idx] = { ...newTasks[start + idx], [col]: normalized };
    });
  });
  return newTasks;
}
  function updateTask(weekId, rowIndex, col, field, value){
    setWeeks(prev => prev.map(w => {
      if(w.id !== weekId) return w;
      let newTasks = [...w.tasks];
      newTasks[rowIndex] = { ...newTasks[rowIndex], [col]: { ...newTasks[rowIndex][col], [field]: value } };
      newTasks = sortColumnByCategory(newTasks, col);
      return { ...w, tasks: newTasks };
    }));
  }
/* Auto-resize all textareas on load/refresh */
useEffect(() => {
  Object.values(inputRefs.current).forEach(el => {
    if (el) {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    }
  });
}, [weeks]);

/* drag/drop */
function handleDrop(e, weekId, targetRow, col){
  e.preventDefault();
  if(!draggedItem || draggedItem.weekId !== weekId || draggedItem.col !== col){
    setDraggedItem(null);
    return;
  }

  setWeeks(prev => prev.map(w => {
    if(w.id !== weekId) return w;
    let tasks = [...w.tasks];

    // Get dragged and target cells
    const draggedCell = tasks[draggedItem.rowIndex][col];
    const targetCell = tasks[targetRow][col];

    // Swap them
    tasks[draggedItem.rowIndex] = {
      ...tasks[draggedItem.rowIndex],
      [col]: targetCell
    };
    tasks[targetRow] = {
      ...tasks[targetRow],
      [col]: draggedCell
    };

    // Renumber this column after swap
    tasks = tasks.map((t, i) => ({
      ...t,
      [col]: { ...t[col], ranking: i + 1 }
    }));

    return { ...w, tasks };
  }));

  setDraggedItem(null);
}


  /* keyboard nav + alt+enter fix */
  function focusCell(weekId, row, col){
    if(row < 0 || col < 0 || col >= columns.length || row >= 16) return;
    const key = `${weekId}-${row}-${col}`;
    const el = inputRefs.current[key];
    if(el) el.focus();
  }
  function handleKeyDown(e, weekId, row, col){
    if(e.key === 'Enter' && e.altKey){
      e.preventDefault();
      const el = e.target;
      const start = el.selectionStart;
      const end = el.selectionEnd;
      el.value = el.value.slice(0, start) + '\n' + el.value.slice(end);
      el.selectionStart = el.selectionEnd = start + 1;
      return;
    }
    if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); focusCell(weekId, row+1, col); }
    else if(e.key === 'Enter' && e.shiftKey){ e.preventDefault(); focusCell(weekId, row-1, col); }
    else if(e.key === 'Tab' && !e.shiftKey){ e.preventDefault(); focusCell(weekId, row, col+1); }
    else if(e.key === 'Tab' && e.shiftKey){ e.preventDefault(); focusCell(weekId, row, col-1); }
  }

  /* add new week */
  function addNewWeek(){
    const prev = weeks[0];
    const nowYear = new Date().getFullYear();
    const nextNum = prev && typeof prev.weekNumber === 'number' ? prev.weekNumber + 1 : currentWeek;
    const newWeek = { id: Date.now(), weekNumber: nextNum, year: nowYear, tasks: makeEmptyTasks() };
    if(prev){
      const openDel = prev.tasks.filter(t => t.delegatedTasks.text.trim() && !t.delegatedTasks.completed);
      const openObj = prev.tasks.filter(t => t.weeklyObjectives.text.trim() && !t.weeklyObjectives.completed);
      openDel.forEach((t, idx) => { if(idx < 16) newWeek.tasks[idx].delegatedTasks = { ...t.delegatedTasks, completed:false }; });
      openObj.forEach((t, idx) => { if(idx < 16) newWeek.tasks[idx].weeklyObjectives = { ...t.weeklyObjectives, completed:false }; });
    }
    setWeeks([newWeek, ...weeks]);
  }

  /* save/load */
function saveToFile(){
  const blob = new Blob([JSON.stringify(weeks, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const today = new Date().toISOString().split('T')[0]; // yyyy-mm-dd
  a.download = `weekly-organizer-${today}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

  function loadFromFile(e){
    const f = e.target.files?.[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try { setWeeks(JSON.parse(ev.target.result)); } catch { alert('Invalid file'); }
    };
    r.readAsText(f);
  }

  /* localStorage autosave (still keeps a backup) */
  useEffect(()=> {
    try { localStorage.setItem('weekly-task-organizer', JSON.stringify(weeks)); } catch {}
  }, [weeks]);

  /* ðŸ”¹ NEW: auto-download 2 minutes after last change */
  useEffect(() => {
    if (!weeks || weeks.length === 0) return;

    const timer = setTimeout(() => {
      saveToFile();
    }, 2 * 60 * 1000); // 2 minutes

    return () => clearTimeout(timer); // reset timer if more edits happen
  }, [weeks]);

  /* week number edit */
  function updateWeekNumber(weekId, newNumber){
    setWeeks(prev => prev.map(w => w.id === weekId ? { ...w, weekNumber: newNumber } : w));
  }

  /* today detection */
  const today = new Date();
  const todayKey = `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
  /* summary filter + rows */
  const [summaryFilter, setSummaryFilter] = useState('All');
  const summaryRows = useMemo(() => {
    const rows = [];
    const mapColName = {
      delegatedTasks: 'Delegated',
      weeklyObjectives: 'Objectives',
      monday: 'Monday',
      tuesday: 'Tuesday',
      wednesday: 'Wednesday',
      thursday: 'Thursday',
      friday: 'Friday'
    };
    weeks.slice().reverse().forEach(w => {
      columns.forEach(col => {
        w.tasks.forEach((t, idx) => {
          const cell = t[col];
          if(cell.text.trim() && !cell.completed){
            rows.push({
              key: `${w.id}-${col}-${idx}`,
              weekId: w.id,
              weekNumber: w.weekNumber,
              year: w.year,
              col,
              colLabel: mapColName[col],
              text: cell.text
            });
          }
        });
      });
    });
    return rows.filter(r => {
      if(summaryFilter === 'All') return true;
      if(summaryFilter === 'Delegated') return r.col === 'delegatedTasks';
      if(summaryFilter === 'Objectives') return r.col === 'weeklyObjectives';
      if(summaryFilter === 'Days') return ['monday','tuesday','wednesday','thursday','friday'].includes(r.col);
      return true;
    });
  }, [weeks, summaryFilter]);

  function addAllToNextWeekFromSummary(){
    if(summaryRows.length === 0) return;
    const latest = weeks[0];
    const nowYear = new Date().getFullYear();
    const nextNum = latest && typeof latest.weekNumber === 'number' ? latest.weekNumber + 1 : currentWeek;
    let nextWeek = weeks.find(w => w.weekNumber === nextNum && w.year === nowYear);
    if(!nextWeek){
      nextWeek = { id: Date.now(), weekNumber: nextNum, year: nowYear, tasks: makeEmptyTasks() };
      setWeeks(prev => [nextWeek, ...prev]);
      setTimeout(()=> doCopyTo(nextWeek.id), 0);
    } else {
      doCopyTo(nextWeek.id);
    }
  }

  function doCopyTo(nextWeekId){
    setWeeks(prev => prev.map(w => {
      if(w.id !== nextWeekId) return w;
      const tasks = [...w.tasks];
      let writeIndex = 15;
      summaryRows.forEach(row => {
        if(writeIndex < 0) return;
        tasks[writeIndex].weeklyObjectives = { text: row.text, completed: false, ranking: writeIndex+1 };
        writeIndex--;
      });
      return { ...w, tasks };
    }));
    setCopiedKeys(prev => {
      const next = new Set(prev);
      summaryRows.forEach(r => next.add(r.key));
      return next;
    });
  }
  return (
    <div className="p-1 bg-white min-h-screen">
      <div className="bg-white w-full">
        {/* Tabs */}
        <div className="flex items-center gap-2 px-2 py-2 border-b border-gray-200">
          <button
            onClick={()=>setActiveTab('organizer')}
            className={`px-4 py-2 rounded-md text-sm font-medium transition ${
              activeTab==='organizer'
                ? 'bg-blue-600 text-white shadow'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            Weekly Organizer
          </button>
          <button
            onClick={()=>setActiveTab('summary')}
            className={`px-4 py-2 rounded-md text-sm font-medium transition ${
              activeTab==='summary'
                ? 'bg-blue-600 text-white shadow'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            Monthly Summary
          </button>

          <div className="ml-auto flex gap-2">
            <button onClick={saveToFile} className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded">Save</button>
            <button onClick={()=>fileInputRef.current?.click()} className="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded">Load</button>
            <input ref={fileInputRef} type="file" accept=".json" className="hidden" onChange={loadFromFile} />
            {activeTab==='organizer' && (
              <button onClick={addNewWeek} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">Add Week</button>
            )}
          </div>
        </div>

        {activeTab==='organizer' ? (
          <div>
            {weeks.map((week)=>{
              const year = week.year || currentYear;
              const wkNum = Number(week.weekNumber) || currentWeek;
              const monday = getDateOfISOWeek(wkNum, year);
              const dates = [
                monday,
                new Date(monday.getFullYear(), monday.getMonth(), monday.getDate()+1),
                new Date(monday.getFullYear(), monday.getMonth(), monday.getDate()+2),
                new Date(monday.getFullYear(), monday.getMonth(), monday.getDate()+3),
                new Date(monday.getFullYear(), monday.getMonth(), monday.getDate()+4)
              ];

              // compute which weekday column is "today" (Mon..Fri = indices 2..6)
              let todayColIndex = -1;
              dates.forEach((d,i)=>{
                const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                if(key === todayKey) todayColIndex = i + 2;
              });

              return (
                <table key={week.id} className="w-full border-collapse mb-2">
                  <thead>
                    <tr>
                      {/* first header cell: week number inline + smaller font */}
                      <th
                        className="text-white text-center px-2 py-1 text-xs"
                        style={{
                          background: todayColIndex===0 ? '#3b82f6' : '#374151',
                          borderLeft: todayColIndex===0 ? '3px solid #2563eb' : '0',
                          borderRight: todayColIndex===0 ? '3px solid #2563eb' : '0',
                          whiteSpace: 'nowrap'
                        }}
                      >
                        Week{" "}
                        <input
                          value={week.weekNumber}
                          onChange={(e)=> updateWeekNumber(week.id, parseInt(e.target.value) || 0)}
                          className="w-10 text-xs font-semibold bg-transparent border-b border-gray-300 focus:outline-none text-white text-center"
                          title="Click to edit week number"
                        />{" "}
                        / Delegated Tasks
                      </th>

                      {/* weekly objectives */}
                      <th
                        className="text-white text-center px-2 py-1 text-xs"
                        style={{ background:'#374151', whiteSpace:'nowrap' }}
                      >
                        Weekly Objectives
                      </th>

                      {/* weekdays with date inline; highlight today with bright blue */}
                      {["Monday","Tuesday","Wednesday","Thursday","Friday"].map((day,i)=>{
                        const idx = i + 2;
                        const isToday = idx === todayColIndex;
                        return (
                          <th
                            key={day}
                            className="text-white text-center px-2 py-1 text-xs"
                            style={{
                              background: isToday ? '#3b82f6' : '#374151',
                              borderLeft: isToday ? '3px solid #2563eb' : '0',
                              borderRight: isToday ? '3px solid #2563eb' : '0',
                              whiteSpace:'nowrap'
                            }}
                          >
                            {day} ({formatDayShort(dates[i])})
                          </th>
                        );
                      })}
                    </tr>
                  </thead>

                  <tbody>
                    {week.tasks.map((task,rowIndex)=>(
                      <tr key={rowIndex}>
                        {["delegatedTasks","weeklyObjectives","monday","tuesday","wednesday","thursday","friday"].map((col,colIndex)=>{
                          const style = getCellStyle(col,rowIndex);
                          const isToday = colIndex === todayColIndex;
                          const leftBorder = colIndex === 0 ? '0' : '1px solid rgba(0,0,0,0.06)';
                          const cellBorderLeft = isToday ? '3px solid #2563eb' : leftBorder;
                          const cellBorderRight = isToday ? '3px solid #2563eb' : '0';

                          return (
                           <td
  key={col}
  onDragOver={(e)=>e.preventDefault()}
  onDrop={(e)=>handleDrop(e,week.id,rowIndex,col)}
  style={{
    backgroundColor: style.bg,
    color: style.text==='white'?'#fff':'#000',
    padding:'6px',
    borderLeft: cellBorderLeft,
    borderRight: cellBorderRight,
    verticalAlign:'top'
  }}
>
  <div style={{ display:'flex', alignItems:'flex-start', gap:4 }}>
    {/* control stack: ranking + checkbox */}
    {/* ðŸ”¹ Entire control stack (ranking + checkbox) is now the drag handle */}
<div
  draggable
  onDragStart={(e)=>setDraggedItem({weekId:week.id,rowIndex,col})}
  style={{
    display: 'flex',
    flexDirection: 'column',
    alignItems: 'center',
    justifyContent: 'flex-start',
    gap: 2,
    width: 20,
    cursor: 'grab'
  }}
>
  <input
    type="number"
    min="1"
    value={task[col].ranking}
    onChange={(e)=>updateTask(
      week.id,rowIndex,col,'ranking',
      parseInt(e.target.value)||1
    )}
    style={{
      width: 18,
      height: 16,
      textAlign: 'center',
      fontSize: 10,
      lineHeight: '16px',
      background: style.bg,
      color: style.text==='white' ? '#fff' : '#000',
      border: 'none',
      outline: 'none',
      padding: 0,
    }}
  />
  <input
    type="checkbox"
    checked={task[col].completed}
    onChange={(e)=>updateTask(week.id,rowIndex,col,'completed',e.target.checked)}
    style={{ width:14, height:14, margin:0, padding:0 }}
  />
</div>


    {/* textarea fills the rest */}
    <div style={{ flex:1 }}>
      <textarea
        value={task[col].text}
        onChange={(e)=>updateTask(week.id,rowIndex,col,'text',e.target.value)}
        onKeyDown={(e)=>handleKeyDown(e,week.id,rowIndex,colIndex)}
        ref={el=>{
          if(!inputRefs.current) inputRefs.current={};
          inputRefs.current[`${week.id}-${rowIndex}-${colIndex}`]=el;
        }}
        placeholder="Task..."
        style={{
          width:'100%',
          minHeight:20,
          resize:'none',
          overflow:'hidden',
          background: style.bg,
          color: style.text==='white' ? '#fff' : '#000',
          border:'none',
          outline:'none',
          fontSize:12,
          lineHeight:'1.2rem'
        }}
        onInput={(e)=>{
          e.target.style.height='auto';
          e.target.style.height=e.target.scrollHeight+'px';
        }}
      />
    </div>
  </div>
</td>

                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              );
            })}
          </div>
        ) : (
          /* ---------- SUMMARY TAB ---------- */


          /* ---------- SUMMARY TAB ---------- */
          <div className="w-full p-3">
            <div className="flex items-center gap-3 mb-3">
              <label className="text-sm text-gray-600">Filter:</label>
              <select
                value={summaryFilter}
                onChange={(e)=>setSummaryFilter(e.target.value)}
                className="border border-gray-300 rounded px-2 py-1 text-sm"
              >
                <option>All</option>
                <option>Delegated</option>
                <option>Objectives</option>
                <option>Days</option>
              </select>

              <button
                onClick={addAllToNextWeekFromSummary}
                className="ml-auto flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded"
                title="Add all open tasks below to the next week's Weekly Objectives (creates it if needed). Tasks will fill from the bottom."
              >
                Add All to Next Week
              </button>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full" style={{ borderCollapse:'collapse' }}>
                <thead>
                  <tr className="bg-gray-700 text-white text-sm">
                    <th className="p-2 text-center">Week</th>
                    <th className="p-2 text-center">Year</th>
                    <th className="p-2 text-center">Column</th>
                    <th className="p-2 text-center">Task</th>
                    <th className="p-2 text-center">Copied</th>
                  </tr>
                </thead>
                <tbody>
                  {summaryRows.length === 0 ? (
                    <tr>
                      <td colSpan="5" className="p-4 text-center text-gray-500">No open tasks ðŸŽ‰</td>
                    </tr>
                  ) : summaryRows.map(row => (
                    <tr key={row.key} className="border-b border-gray-200">
                      <td className="p-2 text-center">{row.weekNumber}</td>
                      <td className="p-2 text-center">{row.year}</td>
                      <td className="p-2 text-center">{row.colLabel}</td>
                      <td className="p-2">{row.text}</td>
                      <td className="p-2 text-center">{copiedKeys.has(row.key) ? 'âœ“' : ''}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* ---------- boot ---------- */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<WeeklyTaskOrganizer />);
</script>
</body>
</html>
